name: Deploy Flutter Desktop to Web

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH Connect and Build
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # --- CONFIGURATION ---
            REPO_URL="https://github.com/saravanan2k03/attandance_desktop.git"
            TARGET_DIR="/root/attandance_desktop"
            FLUTTER_BIN="/opt/flutter/bin/flutter"
            
            # --- STEP 1: FIX BROKEN FOLDER ---
            # If folder exists but is NOT a valid git repo, delete it so we can clone fresh.
            if [ -d "$TARGET_DIR" ] && [ ! -d "$TARGET_DIR/.git" ]; then
              echo "âš ï¸ Folder exists but is corrupted. Deleting..."
              rm -rf "$TARGET_DIR"
            fi

            # --- STEP 2: CLONE OR PULL ---
            if [ ! -d "$TARGET_DIR" ]; then
              echo "ðŸš€ Cloning new repository..."
              git clone $REPO_URL $TARGET_DIR
            else
              echo "ðŸ”„ Pulling latest changes..."
              cd $TARGET_DIR
              git pull origin main
            fi

            # Ensure we are inside the folder
            cd $TARGET_DIR

            # --- STEP 3: CREATE 'dotenv' FILE ---
            echo "BasKey=${{ secrets.BAS_KEY }}" > dotenv
            echo "IvKey=${{ secrets.IV_KEY }}" >> dotenv
            echo "prodbaseUrl=${{ secrets.PROD_BASE_URL }}" >> dotenv
            echo "âœ… Secrets file 'dotenv' created."

            # --- STEP 4: BUILD SEQUENCE (USING FULL PATHS) ---
            echo "ðŸ§¹ Running clean..."
            $FLUTTER_BIN clean
            
            echo "ðŸ“¦ Running pub get..."
            $FLUTTER_BIN pub get

            echo "ðŸ”¨ Building Web App..."
            # --base-href is required because we host at /hourlydotapp/
            $FLUTTER_BIN build web --release --base-href "/hourlydotapp/"

            echo "âœ… Deployment Complete. Nginx is serving the new files."